name: Sync Yandex Disk to PR

on:
  schedule:
    - cron: '0 17 * * *'
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

env:
  PUBLIC_URL: ${{ vars.YANDEX_PUBLIC_URL }}
  PUBLIC_PATH: ${{ vars.YANDEX_PUBLIC_PATH }}
  TARGET_NAME: ${{ vars.YANDEX_TARGET_NAME }}
  DEST_PATH: ${{ vars.YANDEX_DEST_PATH }}
  DEST_FILENAME: ${{ vars.YANDEX_DEST_FILENAME }}

jobs:
  sync:
    concurrency:
      group: sync-yadisk
      cancel-in-progress: true
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Fetch resource metadata
        id: metadata
        run: |
          API_BASE="https://cloud-api.yandex.net/v1/disk/public/resources"
          META_URL="$API_BASE?public_key=$(printf '%s' "$PUBLIC_URL" | jq -sRr @uri)"
          [[ -n "$PUBLIC_PATH" ]] && META_URL="${META_URL}&path=$(printf '%s' "$PUBLIC_PATH" | jq -sRr @uri)"

          echo "::notice::Fetching metadata from Yandex Disk"
          curl -sS "$META_URL" > metadata.json
          TYPE=$(jq -r '.type' metadata.json)
          echo "::notice::Resource type: $TYPE"
          echo "type=$TYPE" >> $GITHUB_OUTPUT

      - name: Resolve file from directory
        if: steps.metadata.outputs.type == 'dir'
        run: |
          echo "::notice::Searching directory for file: $TARGET_NAME"
          FILE_PATH=$(jq -r '.path' metadata.json)
          LIST_URL="$API_BASE?public_key=$(printf '%s' "$PUBLIC_URL" | jq -sRr @uri)&path=$(printf '%s' "$FILE_PATH" | jq -sRr @uri)&limit=1000"

          curl -sS "$LIST_URL" | jq --arg name "$TARGET_NAME" '.._embedded.items[] | select(.type == "file" and .name == $name)' > file_meta.json
          echo "::notice::File found in directory"
        env:
          API_BASE: https://cloud-api.yandex.net/v1/disk/public/resources

      - name: Resolve file metadata
        if: steps.metadata.outputs.type == 'file'
        run: |
          cp metadata.json file_meta.json

      - name: Get download URL
        id: download
        run: |
          API_BASE="https://cloud-api.yandex.net/v1/disk/public/resources"
          FILE_PATH=$(jq -r '.path' file_meta.json)
          DOWNLOAD_URL="$API_BASE/download?public_key=$(printf '%s' "$PUBLIC_URL" | jq -sRr @uri)&path=$(printf '%s' "$FILE_PATH" | jq -sRr @uri)"

          echo "::notice::Requesting download URL for: $(basename "$FILE_PATH")"
          HREF=$(curl -sS "$DOWNLOAD_URL" | jq -r '.href')
          echo "url=$HREF" >> $GITHUB_OUTPUT

      - name: Download file
        run: |
          mkdir -p "$DEST_PATH"
          echo "::notice::Downloading to: $DEST_PATH/$DEST_FILENAME"
          curl -sS -o "$DEST_PATH/$DEST_FILENAME" "${{ steps.download.outputs.url }}"

          SIZE=$(stat -c%s "$DEST_PATH/$DEST_FILENAME" 2>/dev/null || stat -f%z "$DEST_PATH/$DEST_FILENAME")
          echo "::notice::Downloaded $(numfmt --to=iec-i --suffix=B $SIZE 2>/dev/null || echo "$SIZE bytes")"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: 'chore(sync): Yandex Disk update'
          title: 'Sync: Yandex Disk update'
          body: |
            Automated sync from Yandex Disk public share.
            - Source: ${{ env.PUBLIC_URL }} ${{ env.PUBLIC_PATH && format('(path: {0})', env.PUBLIC_PATH) }}
            - Main FPF document: https://github.com/${{ github.repository }}/blob/main/${{ env.DEST_PATH }}/${{ env.DEST_FILENAME }}
            - Agentic diff evaluation will run automatically in this PR.
          branch: sync/yadisk
          delete-branch: true
          labels: |
            sync:auto-merge
          add-paths: |
            ${ env.DEST_PATH }/${ env.DEST_FILENAME }

name: Sync Yandex Disk to PR

on:
  schedule:
    - cron: '*/30 * * * *' # every 30 minutes
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

env:
  # Configure via repository Variables (Settings → Variables → Actions)
  # or Secrets. Fallback to the provided public link.
  PUBLIC_URL: ${{ vars.YANDEX_PUBLIC_URL || secrets.YANDEX_PUBLIC_URL || 'https://disk.yandex.ru/d/N2xaJZWo-hhFYw' }}
  PUBLIC_PATH: ${{ vars.YANDEX_PUBLIC_PATH }}
  TARGET_NAME: ${{ vars.YANDEX_TARGET_NAME }}
  DEST_PATH: yadisk
  DEST_FILENAME: ${{ vars.YANDEX_DEST_FILENAME }}

jobs:
  sync:
    concurrency:
      group: sync-yadisk
      cancel-in-progress: true
    timeout-minutes: 10
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        # Pin action to commit SHA for supply-chain hardening
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
        with:
          persist-credentials: false

      - name: Setup Bun
        uses: oven-sh/setup-bun@f4d14e03ff726c06358e5557344e1da148b56cf7 # v1
        with:
          bun-version: '1.2.3'

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Download from Yandex Disk
        run: |
          bun scripts/yadisk-sync.mjs --max-bytes "${{ vars.YANDEX_MAX_BYTES || '10485760' }}"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@c5a7806660adbe173f04e3e038b0ccdcd758773c # v6
        with:
          commit-message: 'chore(sync): Yandex Disk update'
          title: 'Sync: Yandex Disk update'
          body: |
            Automated sync from Yandex Disk public share.
            - Source: ${{ env.PUBLIC_URL }} ${{ env.PUBLIC_PATH && format('(path: {0})', env.PUBLIC_PATH) }}
          branch: sync/yadisk
          delete-branch: true
          add-paths: |
            yadisk/**

name: FPF pattern research

on:
  workflow_dispatch:
  schedule:
    - cron: "0 17 * * *"

jobs:
  scan:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    env:
      SPEC_PATH: "yadisk/First Principles Framework ‚Äî Core Conceptual Specification (holonic).md"
      JOURNAL_PATH: "docs/research/fpf-pattern-journal.md"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "latest"

      - name: Install dependencies
        run: bun install --no-progress

      - name: Run pattern scanner
        run: bun run scripts/pattern-research.ts
        env:
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_SHA: ${{ github.sha }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Check for updates
        id: git_status
        run: |
          # Check if journal, history, or outputs changed
          if git diff --quiet --exit-code -- "$JOURNAL_PATH" docs/research/pattern-history/ docs/research/pattern-outputs/; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

          # Extract alert level from latest JSON output
          LATEST_JSON=$(ls -t docs/research/pattern-outputs/patterns-*.json 2>/dev/null | head -1)
          if [ -f "$LATEST_JSON" ]; then
            ALERT_LEVEL=$(bun -e "console.log(JSON.parse(require('fs').readFileSync('$LATEST_JSON', 'utf8')).summary.alertLevel)")
            echo "alert_level=$ALERT_LEVEL" >> "$GITHUB_OUTPUT"
          else
            echo "alert_level=none" >> "$GITHUB_OUTPUT"
          fi

      - name: Create pull request
        if: steps.git_status.outputs.changed == 'true'
        run: |
          branch="fpf-pattern-research-${{ github.run_id }}"
          git switch -c "$branch"

          # Add all research outputs
          git add "$JOURNAL_PATH"
          git add docs/research/pattern-history/
          git add docs/research/pattern-outputs/

          git -c user.name="github-actions[bot]" -c user.email="41898282+github-actions[bot]@users.noreply.github.com" \
            commit -m "Update FPF pattern research journal and outputs"
          git push -u origin "$branch"

          # Extract summary from latest JSON
          LATEST_JSON=$(ls -t docs/research/pattern-outputs/patterns-*.json 2>/dev/null | head -1)
          ALERT_LEVEL="${{ steps.git_status.outputs.alert_level }}"

          # Determine alert emoji and labels
          if [ "$ALERT_LEVEL" = "high" ]; then
            ALERT_EMOJI="üö®"
            LABELS="automation,research,priority:high"
          elif [ "$ALERT_LEVEL" = "medium" ]; then
            ALERT_EMOJI="‚ö†Ô∏è"
            LABELS="automation,research,priority:medium"
          elif [ "$ALERT_LEVEL" = "low" ]; then
            ALERT_EMOJI="‚ÑπÔ∏è"
            LABELS="automation,research"
          else
            ALERT_EMOJI="‚úì"
            LABELS="automation,research"
          fi

          # Build PR body
          cat <<MD > pr-body.md
          ## ${ALERT_EMOJI} FPF Pattern Research ‚Äî Enhanced Analysis

          **Run ID:** ${{ github.run_id }}
          **Commit:** ${{ github.sha }}
          **Date:** $(date -u +%F)
          **Alert Level:** \`${ALERT_LEVEL}\`

          ### üìä What's New

          This PR includes:
          - ‚úÖ **Updated Pattern Journal** with historical entries
          - ‚úÖ **JSON Output** for programmatic analysis
          - ‚úÖ **Dependency Graph** (Mermaid diagram)
          - ‚úÖ **Historical Snapshot** for trend analysis
          - ‚úÖ **AI-Powered Insights** (if API key configured)
          - ‚úÖ **Dynamic Cluster Discovery** based on cross-references

          ### üìÅ Files Changed

          - \`docs/research/fpf-pattern-journal.md\` - Main journal with latest entry
          - \`docs/research/pattern-history/*.json\` - Historical snapshots
          - \`docs/research/pattern-outputs/*.json\` - Detailed analysis output
          - \`docs/research/pattern-outputs/*.md\` - Dependency graph

          ### üîç Review Guide

          1. **Check the Journal**: Review the latest entry in \`fpf-pattern-journal.md\`
          2. **See What Changed**: Look for Added/Modified/Removed patterns
          3. **View Clusters**: New pattern relationships discovered
          4. **Read AI Analysis**: Insights about architectural implications
          5. **Check Graphs**: Visual dependency relationships

          ### ü§ñ Analysis Details

          The enhanced workflow now:
          - Tracks changes over time (not just snapshots)
          - Discovers pattern clusters automatically via cross-references
          - Provides LLM-powered insights on architectural implications
          - Generates multiple output formats (Markdown, JSON, Mermaid)
          - Sets alert levels based on change significance

          ### üìà Outputs

          - [View Latest JSON Output](../blob/$branch/$LATEST_JSON)
          - [View Pattern Journal](../blob/$branch/docs/research/fpf-pattern-journal.md)

          ### ‚ö° Next Steps

          - Review the changes and AI insights
          - Merge if analysis looks correct
          - Check dependency graph for new relationships

          ---

          *This PR was automatically generated by the enhanced FPF Pattern Research workflow.*
          MD

          gh pr create \
            --title "[automation] ${ALERT_EMOJI} FPF pattern research ‚Äì $(date -u +%F)" \
            --body-file pr-body.md \
            --label "$LABELS"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: No-op summary
        if: steps.git_status.outputs.changed != 'true'
        run: echo "No changes detected in $JOURNAL_PATH"
